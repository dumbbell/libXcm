
COLLECT = ar cru
RANLIB = ranlib
LNK = ln -s
RPMARCH = `rpmbuild --showrc | awk '/^build arch/ {print $$4}'`
MSGCAT = msgcat
MSGFMT = msgfmt -c --statistics

C99=-std=c99
CFLAGS_=$(CFLAGS) -pedantic

docdir          = $(datadir)/doc/$(TARGET)
SRCDIR          = $(src_dir)
BUILDDIR        = $(build_dir)/

LIBRARIES = $(TARGET)
LIB=
LIBSONAMEFULL = $(LIB)$(TARGET)$(SO).$(VERSION)$(LIBEXT)
LIBSONAME = $(LIB)$(TARGET)$(SO).$(VERSION_A)$(LIBEXT)
LIBSO = $(LIB)$(TARGET)$(SO)$(LIBEXT)
LIBNAME = $(LIB)$(TARGET).a


INCL= -I/usr/include -I$(includedir) -I/usr/X11R6/include -I$(SRCDIR)/include \
	$(X_H) $(OS_INCL)

LDLIBS = $(LDFLAGS) -L$(libdir) -L. \
	 $(c)

CHEADERS = \
	include/$(TARGET_BASE).h \
	include/$(TARGET_BASE)DDC.h \
	include/$(TARGET_BASE)EdidParse.h \
	include/$(TARGET_BASE)Events.h
CFILES = \
	src/$(TARGET_BASE)DDC.c \
	src/$(TARGET_BASE)EdidParse.c
X11_CFILES = \
	src/$(TARGET_BASE).c \
	src/$(TARGET_BASE)Events.c

TEST_CPP = \
	tests/dl_test.cxx \
	tests/intptr_test.c \
	tests/lib_test.cxx \
	tests/library.c
CPPFILES =
CXXFILES =
TEST_FILES = $(TEST_CPP) $(TEST_H)


DOKU =  AUTHORS \
        ChangeLog \
        COPYING \
        README
SUB_DOKU = \
	docs/net-color-spec
DIST_FILES = \
	Doxyfile.in
MAN3_GENERATED = doc/man/man3/*
MAN3_HAND = lib$(TARGET_BASE).3
MAN1 =
MAN3 =  $(MAN3_HAND) $(MAN3_GENERATED)

TOP_SOURCES =
SOURCES =  \
	$(TOP_SOURCES) \
	$(CFILES) \
	$(X11_CFILES)

# we need these files to generate explicite targets for out of tree builds
COBJECTS = \
	$(CFILES:.c=.o)
CXXOBJECTS =	$(CXXFILES)
X11_COBJECTS = $(X11_CFILES:.c=.o)

#ifdef X11
X11_OBJECTS = $(X11_COBJECTS)
#endif
OBJECTS = $(CPPFILES:.cpp=.o) $(CXXFILES:.cxx=.o) $(CFILES:.c=.o) $(X11_OBJECTS)

CLEAN_OBJECTS = \
	$(OBJECTS)

SUB_OBJECTS = \
	$(CFILES:.c=.o) \
	$(X11_OBJECTS)

INCL_DEP = $(SOURCES)


CONFIG_FILES = \
	$(SRCDIR)/configure \
	$(SRCDIR)/configure_tests.sh \
	$(SRCDIR)/makefile.in \
	$(SRCDIR)/$(TARGET_MINI).pc.in \
	$(SRCDIR)/$(TARGET).spec.in \
	$(SRCDIR)/$(TARGET)_control.in

ALL_FILES = \
	$(DOKU) \
	$(DIST_FILES) \
	$(TOP_SOURCES) \
	$(TOP_CHEADERS) \
	$(MAN1) $(MAN3_HAND)

# build all what is needed to run the libraries, helpers
all:	config.log.h mkdepend \
	$(LIBSONAMEFULL)
	echo ... $@ done

# get time stamp
MTIME   := $(shell date +%y%m%d.%H%M%S)

# this is a test
time:
	echo $(MTIME)

# build all objects and libraries, link the headers to $(TARGET)
$(LIBSONAMEFULL):	$(OBJECTS) $(LIBNAME)
	echo Linking $@ ...
	$(CC) -I./ $(CFLAGS_) $(LINK_FLAGS_DYNAMIC)$(dyld_libdir)$(LIBSONAME) \
	-o $(LIBSONAMEFULL) \
	$(OBJECTS) \
	-L$(libdir) $(LDLIBS) $(m) $(X11_LIBS)
	$(RM)  $(LIBSONAME)
	$(LNK) $(LIBSONAMEFULL) $(LIBSONAME)
	$(RM)  $(LIBSO)
	$(LNK) $(LIBSONAMEFULL) $(LIBSO)




$(LIBNAME):	$(OBJECTS)
	echo Linking $@ ...
	test -f $(LIBNAME) && $(RM) $(LIBNAME) || echo ""
	$(COLLECT) $(LINK_FLAGS_STATIC) $(LIBNAME) \
		$(OBJECTS)
	$(RANLIB) $(LIBNAME)

check:	all
	echo current git version is:
	n=0; for i in `cd $(SRCDIR); git rev-list master`; do if [ $${n} -eq 0 ]; then echo git id:$${i}; fi; n=1; done





# the copy part for this directory level
install-bin:	install_bin
install_bin:	all
	echo Installing binaries ...
	mkdir -p $(DESTDIR)$(libdir)
	mkdir -p $(DESTDIR)$(libdir)/pkgconfig
	$(INSTALL) -m 644 $(TARGET_MINI).pc $(DESTDIR)$(libdir)/pkgconfig/
	for lib in $(LIBRARIES); do \
	   test -f $(LIB)$${lib}$(SO).$(VERSION)$(LIBEXT) && \
		($(INSTALL) -m 755 $(LIB)$${lib}$(SO).$(VERSION)$(LIBEXT) \
		$(DESTDIR)$(libdir) \
		); \
	   test -f $(LIB)$${lib}$(SO).$(VERSION)$(LIBEXT) && \
		(test -L $(DESTDIR)$(libdir)/$(LIB)$${lib}$(SO).$(VERSION_A)$(LIBEXT) && $(RM) $(DESTDIR)$(libdir)/$(LIB)$${lib}$(SO).$(VERSION_A)$(LIBEXT); \
		$(LNK)  $(LIB)$${lib}$(SO).$(VERSION)$(LIBEXT) \
		$(DESTDIR)$(libdir)/$(LIB)$${lib}$(SO).$(VERSION_A)$(LIBEXT); \
		test -L $(DESTDIR)$(libdir)/$(LIB)$${lib}$(SO)$(LIBEXT) && ( \
		$(RM) $(DESTDIR)$(libdir)/$(LIB)$${lib}$(SO)$(LIBEXT)) ; \
		$(LNK)  $(LIB)$${lib}$(SO).$(VERSION)$(LIBEXT) \
		$(DESTDIR)$(libdir)/$(LIB)$${lib}$(SO)$(LIBEXT); \
		); \
	   if [ "$(STATIC)" = "" ]; then test -f $(LIB)$${lib}.a && \
		($(INSTALL) -m 644 $(LIB)$${lib}.a $(DESTDIR)$(libdir);\
		$(RANLIB) $(DESTDIR)$(libdir)/$(LIB)$${lib}.a \
		) || echo ""; \
           fi; \
	done
	test -d $(DESTDIR)$(includedir)/X11/Xcm || mkdir -p $(DESTDIR)$(includedir)/X11/Xcm
	cd $(SRCDIR); $(INSTALL) -m 644 $(CHEADERS) $(DESTDIR)$(includedir)/X11/Xcm
	echo ... binary Installation finished

# install recursive
install:	install-main
	echo ... $@ done

install-main:	install_bin install_docu


# synonymes
install_doc:	install_docu
install-docs:	install_docu

install_docu:	docu
	test -d $(DESTDIR)$(docdir) || mkdir -p $(DESTDIR)$(docdir)
	-cd $(SRCDIR); $(INSTALL) -m 644 $(DOKU) $(SUB_DOKU) $(DESTDIR)$(docdir)
	mkdir -p $(DESTDIR)$(mandir)/man3
	cd $(SRCDIR) && \
	  $(INSTALL) -m 644 $(MAN3) $(DESTDIR)$(mandir)/man3
	

docu:	Doxyfile
	-doxygen

# build a source distribution package
dist: targz
	test -d ../Archiv && mv -v ../Archiv/$(TARGET)-$(MTIME).tgz $(TARGET)-$(VERSION).tar.gz || mv -v $(TARGET)-$(MTIME).tgz $(TARGET)-$(VERSION).tar.gz
	tar xzf $(TARGET)-$(VERSION).tar.gz
	tar cjf $(TARGET)-$(VERSION).tar.bz2 $(TARGET)-$(VERSION)/
	$(RM) -R $(TARGET)-$(VERSION)

dist-gzip:	dist

# build a binary rpm package
rpm:	dist
	$(SRCDIR)/configure --prefix=/usr --rpm-only # generate the spec file
	mkdir -p rpmdir/BUILD \
	rpmdir/SPECS \
	rpmdir/SOURCES \
	rpmdir/SRPMS \
	rpmdir/RPMS/$(RPMARCH)
	$(COPY) -f $(TARGET)-$(VERSION).tar.gz rpmdir/SOURCES
	rpmbuild --clean -ba $(build_dir)/$(TARGET).spec --define "_topdir $$PWD/rpmdir"
	@echo "============================================================"
	@echo "Finished - the packages are in rpmdir/RPMS and rpmdir/SRPMS!"

deb:	dist
	$(SRCDIR)/configure --prefix=/usr --rpm-only
	mkdir -p debian/deb/DEBIAN
	tar xvzf $(TARGET)-$(VERSION).tar.gz
	(cd $(TARGET)-$(VERSION); \
	./configure --prefix=/usr; \
	make DESTDIR=$(build_dir)/debian/deb/DEBIAN install;)
	$(COPY) $(TARGET)-$(VERSION)/$(TARGET)_control $(build_dir)/debian/deb/DEBIAN/control
	$(RM) -R $(TARGET)-$(VERSION)
	dpkg -b $(build_dir)/debian/deb debian/$(TARGET)_$(VERSION)-$(RELEASE)_$(deb_arch).deb
	$(RM) -R $(build_dir)/debian/deb
	echo ... $@ done

# remove everything previously installed
uninstall:	uninstall_bin uninstall_docu
	echo ... $@ done

uninstall-bin:
uninstall_bin:
	echo Uninstalling binaries ...
	$(RM)   $(DESTDIR)$(libdir)/pkgconfig/$(TARGET_MINI).pc
	for lib in $(LIBRARIES); do \
	    $(RM) $(DESTDIR)$(libdir)/$(LIB)$${lib}$(SO).$(VERSION)$(LIBEXT) \
	          $(DESTDIR)$(libdir)/$(LIB)$${lib}$(SO).$(VERSION_A)$(LIBEXT) \
	          $(DESTDIR)$(libdir)/$(LIB)$${lib}$(SO)$(LIBEXT) \
	          $(DESTDIR)$(libdir)/$(LIB)$${lib}.a; \
	done
	$(RM)   $(DESTDIR)$(includedir)/X11/$(TARGET_BASE)/$(TARGET_BASE)*.h
	echo ... done uninstalling binaries
	
uninstall-docs:	uninstall_docu
uninstall_docu:
	echo Uninstalling docu ...
	for file in $(DOKU); do \
	  $(RM) $(DESTDIR)$(docdir)/$$file; \
	done
	for file in $(MAN1); do \
	  $(RM) $(DESTDIR)$(mandir)/man1/$$file; \
	done
	for file in $(MAN3); do \
	  $(RM) $(DESTDIR)$(mandir)/man3/$$file; \
	done
	echo ... done uninstalling docu


# remove in this directory
distclean: clean
	-$(RM) Makefile
	-$(RM) mkdepend cobjects config.h $(TARGET_MINI).pc $(TARGET).spec
	-$(RM) config.log $(TARGET)_version.h
	-$(RM) config.log.h config.tmp.sh testset.txt

clean:
	-$(RM) $(CLEAN_OBJECTS)
	-for lib in $(LIBRARIES); do \
	   $(RM) $(LIB)$${lib}$(SO).$(VERSION)$(LIBEXT) \
	         $(LIB)$${lib}$(SO).$(VERSION_A)$(LIBEXT) \
	         $(LIB)$${lib}$(SO)$(LIBEXT) \
	         $(LIB)$${lib}.a; \
	done
	echo ... $@ done

# configure if the file config is not available
config.log.h:	$(CONFIG_FILES) ./config.log
	./config.log

# try to resolve dependencies
depend:	cdepend
	echo "setting up dependencies ..."
	echo "MAKEDEPEND_ISUP = 1" > mkdepend
	echo "#nicht editieren/dont edit - automatisch generiert von makefile.in" >> mkdepend
	-(for file in $(INCL_DEP); do \
	    incl_src="$${incl_src} $(SRCDIR)/$${file}"; done; \
	  $(MAKEDEPEND) -I./ -I$(SRCDIR) $(INCL) $${incl_src} >> mkdepend)
	-for file in $(SUB_OBJECTS); do \
	   obj=`echo $${file} | sed 's%src/%% ; s%xcmsevents/%%'`; \
	   cat mkdepend | sed s%$${obj}%$${file}% > mkdepend.tmp; \
	   mv mkdepend.tmp mkdepend; \
         done

cdepend:
	echo preparing dependency compilation ...
	echo "COBJECTS_ISUP = 1" > cobjects
	echo "#nicht editieren/dont edit - automatisch generiert von makefile.in" >> cobjects
	echo "" >> cobjects
	for i in $(COBJECTS); do \
	  echo "$${i}:	\$$(SRCDIR)/$${i}" | sed s/\.o\$$/.c/ >> cobjects; \
	  echo "	echo Compiling $${i} ..." >> cobjects; \
	  echo '	$$(CC) -I./ -I$$(SRCDIR) $$(CFLAGS_) $$(INCL) -c -o $$*.o $$(SRCDIR)/$$*.c' >> cobjects; \
	  echo "" >> cobjects; \
	done
	for i in $(CPPOBJECTS); do \
	  echo "$${i}:	\$$(SRCDIR)/$${i}" | sed s/\.o\$$/.cpp/ >> cobjects; \
	  echo "	echo Compiling $${i} ..." >> cobjects; \
	  echo '	$$(CXX) -I./ -I$$(SRCDIR) $$(CXXFLAGS) $$(INCL) -c -o $$*.o $$(SRCDIR)/$$*.cpp' >> cobjects; \
	  echo "" >> cobjects; \
	done
	for i in $(CXXOBJECTS); do \
	  echo "$${i}:	\$$(SRCDIR)/$${i}" | sed s/\.o\$$/.cxx/ >> cobjects; \
	  echo "	echo Compiling $${i} ..." >> cobjects; \
	  echo '	$$(CXX) -I./ -I$$(SRCDIR) $$(CXXFLAGS) $$(INCL) -c -o $$*.o $$(SRCDIR)/$$*.cxx' >> cobjects; \
	  echo "" >> cobjects; \
	done


# Build commands and filename extensions...
.SUFFIXES:	.c .cxx .h .fl .o .po


.c.o:
	echo Compiling $(SRCDIR)/$< ...
	$(CC) -I. $(CFLAGS_) $(INCL) -c -o $@ $(SRCDIR)/$<

.cxx.o:
	echo Compiling $(SRCDIR)/$< ...
	$(CXX) -I. $(CXXFLAGS) $(INCL) $(FLTK_H) -c -o $@ $(SRCDIR)/$<

.cpp.o:	mkdepend
	echo Compiling $(SRCDIR)/$< ...
	$(CXX) -I. $(CXXFLAGS) $(INCL) -c -o $@ $(SRCDIR)/$<

.fl.cxx:
	echo Expanding $< ...
	fluid -c $<
	-$(MOVE) `echo $*.cxx $*.h | sed s%$(SRCDIR)/%%g` $(SRCDIR)

.po:
	echo Generating $@ ...
	msgfmt $<


# smallest package covering the current directory
tgz:
	-test -d Entwickeln && $(RM) -r Entwickeln
	$(MAKE) DESTDIR=Entwickeln copy_files
	tar cf - Entwickeln/ \
	| gzip > $(TARGET)_$(MTIME).tgz
	-test -d ../Archiv && mv -v $(TARGET)_*.tgz ../Archiv
	-test -d Entwickeln && \
	test `pwd` != `(cd Entwickeln; pwd)` && \
	rm -R Entwickeln

# build the source package including the subdirectories
targz:
	test -d $(TARGET)-$(VERSION) && $(RM) -R $(TARGET)-$(VERSION) || echo -e "\c"
	$(MAKE) DESTDIR=$(build_dir)/$(TARGET)-$(VERSION) copy_files
	tar cf - $(TARGET)-$(VERSION)/ \
	| gzip > $(build_dir)/$(TARGET)-$(MTIME).tgz
	test -d $(build_dir)/$(TARGET)-$(VERSION) && \
	test `pwd` != `(cd $(build_dir)/$(TARGET)-$(VERSION); pwd)` && \
	$(RM) -R $(build_dir)/$(TARGET)-$(VERSION)
	test -d ../Archiv && mv -v $(TARGET)-*.tgz ../Archiv || echo "no copy"

# basic file set
copy_files:
	mkdir -p $(DESTDIR)
	cd $(SRCDIR) && \
	  $(COPY) -R $(ALL_FILES) $(DESTDIR)
	$(COPY) $(CONFIG_FILES) $(DESTDIR)
	mkdir $(DESTDIR)/docs
	cd $(SRCDIR) && \
	  $(COPY) $(SUB_DOKU) $(DESTDIR)/docs
	mkdir $(DESTDIR)/include
	cd $(SRCDIR) && \
	  $(COPY) $(CHEADERS) $(DESTDIR)/include
	mkdir $(DESTDIR)/src
	cd $(SRCDIR) && \
	  $(COPY) $(CFILES) $(X11_CFILES) $(DESTDIR)/src
	mkdir $(DESTDIR)/tests
	cd $(SRCDIR) && \
	  $(COPY) $(TEST_FILES) $(DESTDIR)/tests
	mkdir -p $(DESTDIR)/doc/man/man3
	cd $(SRCDIR) && \
          $(COPY) $(MAN3_GENERATED) $(DESTDIR)/doc/man/man3
	echo ... $@ done

help:
	echo "... all :        build the binaries"
	echo "non default build targets:"
	echo "... check :      do a test build and run it"
	echo "... "
	echo "... install :    install the binaries, include files and data"
	echo "... install-bin: install only binaries"
	echo "... install-docs: install only documentation"
	echo "... uninstall"
	echo "... clean :      remove binaries, object files and most processed data"
	echo "... distclean :  remove all files processed from configure scripts"
	echo "... rpm :        build RPM's"
	echo "... dist :       build a distribution tarball and place local"
	echo "... targz :      build a distribution tar ball"
	echo "... tgz :        build a development tar ball"
	echo "... copy_files : copy distribution files to a DESTDIR=xxx path"
	echo "... depend :     resolve dependencies"
	echo "  VARIABLES:"
	echo "... DESTDIR=\"/user/a/My Install Dir/\" install"
	echo "... BUILDDIR=../build_local"

# dependencies
include mkdepend
include cobjects

#ifndef MAKEDEPEND_ISUP
mkdepend: depend
#endif
#ifndef COBJECTS_ISUP
cobjects: cdepend
#endif

